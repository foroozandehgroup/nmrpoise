
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Custom cost functions &#8212; poise  documentation</title>
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/alabaster.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../genindex/" />
    <link rel="search" title="Search" href="../search/" />
    <link rel="next" title="Developer notes" href="../dev/" />
    <link rel="prev" title="Builtin AU programmes" href="../au/" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="custom-cost-functions">
<h1>Custom cost functions<a class="headerlink" href="#custom-cost-functions" title="Permalink to this headline">¶</a></h1>
<p>All user-defined cost functions are stored inside the file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$TS/exp/stan/nmr/py/user/poise_backend/costfunctions_user.py
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">$TS</span></code> is your TopSpin installation path.
In order to modify or add cost functions, you will need to edit this file (with your favourite text editor or IDE).</p>
<p>The corresponding file containing builtin cost functions is <code class="docutils literal notranslate"><span class="pre">costfunctions.py</span></code>.
You <em>can</em> edit this file directly: if you add a cost function there, it will work.
However, there are two risks with this.
Firstly, if you ever reinstall POISE, this file will be reset to the default (whereas <code class="docutils literal notranslate"><span class="pre">costfunctions_user.py</span></code> will not).
Secondly, any cost functions defined in <code class="docutils literal notranslate"><span class="pre">costfunctions_user.py</span></code> will shadow (i.e. take priority over) the cost functions defined in <code class="docutils literal notranslate"><span class="pre">costfunctions.py</span></code> if they have the same name.</p>
<section id="the-rules-for-cost-functions">
<h2>The rules for cost functions<a class="headerlink" href="#the-rules-for-cost-functions" title="Permalink to this headline">¶</a></h2>
<p>Cost functions are defined as a standard Python 3 function which takes no parameters and returns a float (the value of the cost function).</p>
<ol class="arabic simple">
<li><p><strong>Do write a useful docstring if possible</strong>: this docstring will be shown to the user when they type <code class="docutils literal notranslate"><span class="pre">poise</span> <span class="pre">-l</span></code> into TopSpin (which lists all available cost functions and routines).</p></li>
<li><p><strong>The spectrum under optimisation, as well as acquisition parameters, can be accessed via helper functions.</strong> These are described more fully below.</p></li>
<li><p><strong>Never print anything inside a cost function directly to stdout</strong>. This will cause the optimisation to stop. If you want to perform debugging, use the <a class="reference internal" href="#nmrpoise.poise_backend.cfhelpers.log" title="nmrpoise.poise_backend.cfhelpers.log"><code class="xref any py py-func docutils literal notranslate"><span class="pre">log</span></code></a> function described below.</p></li>
<li><p><strong>To terminate the optimisation prematurely and return the best point found so far, raise CostFunctionError().</strong> See below for more information.</p></li>
</ol>
</section>
<section id="accessing-spectra-and-parameters">
<h2>Accessing spectra and parameters<a class="headerlink" href="#accessing-spectra-and-parameters" title="Permalink to this headline">¶</a></h2>
<p>The most primitive way of accessing “outside” information is through the class <code class="docutils literal notranslate"><span class="pre">_g</span></code>, which is imported from <code class="docutils literal notranslate"><span class="pre">shared.py</span></code> and contains a series of global variables reflecting the current optimisation.
For example, <code class="docutils literal notranslate"><span class="pre">_g.p_spectrum</span></code> is the path to the procno folder: you can read and parse the <code class="docutils literal notranslate"><span class="pre">1r</span></code> file inside this to get the real spectrum as a <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.21)"><code class="xref any docutils literal notranslate"><span class="pre">numpy.ndarray</span></code></a> (for example).</p>
<dl class="py class">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.shared._g">
<em class="property"><span class="pre">class</span> </em><span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.shared.</span></span><span class="sig-name descname"><span class="pre">_g</span></span><a class="headerlink" href="#nmrpoise.poise_backend.shared._g" title="Permalink to this definition">¶</a></dt>
<dd><p>Class to store the “global” variables.</p>
<dl class="field-list">
<dt class="field-odd">Attributes</dt>
<dd class="field-odd"><dl>
<dt><strong>optimiser</strong><span class="classifier">str from {‘nm’, ‘mds’, ‘bobyqa’}</span></dt><dd><p>The optimiser being used.</p>
</dd>
<dt><strong>routine_id</strong><span class="classifier">str</span></dt><dd><p>The name of the routine being used.</p>
</dd>
<dt><strong>p_spectrum</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a></span></dt><dd><p>The path to the procno folder of the spectrum just acquired. (e.g.
<code class="docutils literal notranslate"><span class="pre">/path/to/data/1/pdata/1</span></code>)</p>
</dd>
<dt><strong>p_optlog</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a></span></dt><dd><p>The path to the currently active <code class="docutils literal notranslate"><span class="pre">poise.log</span></code> file.</p>
</dd>
<dt><strong>p_errlog</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a></span></dt><dd><p>The path to the currently active <code class="docutils literal notranslate"><span class="pre">poise_err_backend.log</span></code> file.</p>
</dd>
<dt><strong>maxfev</strong><span class="classifier">int</span></dt><dd><p>The maximum number of function evaluations specified by the user. Can
be zero, indicating no limit (beyond the hard limit of 500 times the
number of parameters).</p>
</dd>
<dt><strong>p_poise</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a></span></dt><dd><p>The path to the <code class="docutils literal notranslate"><span class="pre">$TS/exp/stan/nmr/py/user/poise_backend</span></code> folder.</p>
</dd>
<dt><strong>spec_f1p</strong><span class="classifier">float or tuple of float</span></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">F1P</span></code> parameter. For a 1D spectrum this is a float. For a 2D
spectrum this is a tuple of floats (<code class="docutils literal notranslate"><span class="pre">indirect,</span> <span class="pre">direct</span></code>) corresponding
to the values of <code class="docutils literal notranslate"><span class="pre">F1P</span></code> in both spectral dimensions.</p>
</dd>
<dt><strong>spec_f2p</strong><span class="classifier">float or tuple of float</span></dt><dd><p>The <code class="docutils literal notranslate"><span class="pre">F2P</span></code> parameter.</p>
</dd>
<dt><strong>xvals</strong><span class="classifier">list of ndarray</span></dt><dd><p>The points sampled during the optimisation, in chronological order.
These are ndarrays which contain the values of the parameters being
optimised at each spectrum acquisition. The parameters are ordered in
the same way as specified in the routine.</p>
</dd>
<dt><strong>fvals</strong><span class="classifier">ndarray</span></dt><dd><p>The values of the cost functions calculated at each stage of the
optimisation.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<p>However, this is quite tedious and error-prone, so there are a number of helper methods which use these primitives.
All the existing cost functions (inside <code class="docutils literal notranslate"><span class="pre">costfunctions.py</span></code>) only use these helper methods.
All of these methods are stored inside <code class="docutils literal notranslate"><span class="pre">cfhelpers.py</span></code> and are already imported by default.</p>
<p>The ones you are likely to use are the following:</p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.make_p_spec">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">make_p_spec</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">path</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">expno</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">procno</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.make_p_spec" title="Permalink to this definition">¶</a></dt>
<dd><p>Constructs a <a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a> object corresponding to the procno folder
<code class="docutils literal notranslate"><span class="pre">&lt;path&gt;/&lt;expno&gt;/pdata/&lt;procno&gt;</span></code>. If parameters are not passed, they are
inherited from the currently active spectrum (<code class="docutils literal notranslate"><span class="pre">_g.p_spectrum</span></code>).</p>
<p>Thus, for example, <code class="docutils literal notranslate"><span class="pre">make_p_spec(expno=1,</span> <span class="pre">procno=1)</span></code> returns a path to the
spectrum with EXPNO 1 and PROCNO 1, but with the same name as the currently
active spectrum.</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl>
<dt><strong>path</strong><span class="classifier">str or <a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a>, optional</span></dt><dd><p>Path to the main folder of the spectrum (one level above the expno
folders).</p>
</dd>
<dt><strong>expno</strong><span class="classifier">int, optional</span></dt><dd></dd>
<dt><strong>procno</strong><span class="classifier">int, optional</span></dt><dd></dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl>
<dt><strong>p_spec</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a></span></dt><dd><p>Path pointing to the requested spectrum.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.get1d_fid">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">get1d_fid</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">remove_grpdly</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.get1d_fid" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the FID as a <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.21)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ndarray</span></code></a>.</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl>
<dt><strong>remove_grpdly</strong><span class="classifier">bool, optional</span></dt><dd><p>Whether to remove the group delay (to be precise, it is shifted to the
end of the FID). Defaults to True.</p>
</dd>
<dt><strong>p_spec</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a>, optional</span></dt><dd><p>Path to the procno folder of interest. (The FID is taken from the expno
folder two levels up.) Defaults to the currently active spectrum (i.e.
<code class="docutils literal notranslate"><span class="pre">_g.p_spectrum</span></code>).</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.21)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ndarray</span></code></a></dt><dd><p>Complex-valued array containing the FID.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.get1d_real">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">get1d_real</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.get1d_real" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the real spectrum as a <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.21)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ndarray</span></code></a>. This function accounts for
TopSpin’s <code class="docutils literal notranslate"><span class="pre">NC_PROC</span></code> variable, scaling the spectrum intensity accordingly.</p>
<p>Note that this function only works for 1D spectra. It does <em>not</em> work for
1D projections of 2D spectra. If you want to work with projections, you can
use <a class="reference internal" href="#nmrpoise.poise_backend.cfhelpers.get2d_rr" title="nmrpoise.poise_backend.cfhelpers.get2d_rr"><code class="xref any py py-func docutils literal notranslate"><span class="pre">get2d_rr</span></code></a> to get the full 2D spectrum, then manipulate it using numpy
functions as appropriate. A documented example can be found in the
<code class="docutils literal notranslate"><span class="pre">asaphsqc()</span></code> function in <code class="docutils literal notranslate"><span class="pre">costfunctions.py</span></code> (commented out by default).</p>
<p>The <em>bounds</em> parameter may be specified in the following formats:</p>
<blockquote>
<div><ul class="simple">
<li><p>between 5 and 8 ppm:  <code class="docutils literal notranslate"><span class="pre">bounds=&quot;5..8&quot;</span></code>  OR <code class="docutils literal notranslate"><span class="pre">bounds=(5,</span> <span class="pre">8)</span></code></p></li>
<li><p>greater than 9.3 ppm: <code class="docutils literal notranslate"><span class="pre">bounds=&quot;9.3..&quot;</span></code> OR <code class="docutils literal notranslate"><span class="pre">bounds=(9.3,</span> <span class="pre">None)</span></code></p></li>
<li><p>less than -2 ppm:     <code class="docutils literal notranslate"><span class="pre">bounds=&quot;..-2&quot;</span></code>  OR <code class="docutils literal notranslate"><span class="pre">bounds=(None,</span> <span class="pre">-2)</span></code></p></li>
</ul>
</div></blockquote>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl>
<dt><strong>bounds</strong><span class="classifier">str or tuple, optional</span></dt><dd><p>String or tuple describing the region of interest. See above for
examples. If no bounds are provided, uses the <code class="docutils literal notranslate"><span class="pre">F1P</span></code> and <code class="docutils literal notranslate"><span class="pre">F2P</span></code>
processing parameters, which can be specified via <code class="docutils literal notranslate"><span class="pre">dpl</span></code>. If these are
not specified, defaults to the whole spectrum.</p>
</dd>
<dt><strong>p_spec</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a>, optional</span></dt><dd><p>Path to the procno folder of interest. Defaults to the currently active
spectrum (i.e. <code class="docutils literal notranslate"><span class="pre">_g.p_spectrum</span></code>).</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.21)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ndarray</span></code></a></dt><dd><p>Array containing the spectrum or the desired section of it (if bounds
were specified).</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.get1d_imag">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">get1d_imag</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.get1d_imag" title="Permalink to this definition">¶</a></dt>
<dd><p>Same as <a class="reference internal" href="#nmrpoise.poise_backend.cfhelpers.get1d_real" title="nmrpoise.poise_backend.cfhelpers.get1d_real"><code class="xref any py py-func docutils literal notranslate"><span class="pre">get1d_real</span></code></a>, except that it reads the imaginary spectrum.</p>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.get2d_rr">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">get2d_rr</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">f1_bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f2_bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.get2d_rr" title="Permalink to this definition">¶</a></dt>
<dd><p>Return the real part of the 2D spectrum (the “RR” quadrant) as a 2D
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.21)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ndarray</span></code></a>. This function takes into account the <code class="docutils literal notranslate"><span class="pre">NC_PROC</span></code> value in
TopSpin’s processing parameters.</p>
<p>The <em>f1_bounds</em> and <em>f2_bounds</em> parameters may be specified in the
following formats:</p>
<blockquote>
<div><ul class="simple">
<li><p>between 5 and 8 ppm:  <code class="docutils literal notranslate"><span class="pre">f1_bounds=&quot;5..8&quot;</span></code>  OR <code class="docutils literal notranslate"><span class="pre">f1_bounds=(5,</span> <span class="pre">8)</span></code></p></li>
<li><p>greater than 9.3 ppm: <code class="docutils literal notranslate"><span class="pre">f1_bounds=&quot;9.3..&quot;</span></code> OR <code class="docutils literal notranslate"><span class="pre">f1_bounds=(9.3,</span> <span class="pre">None)</span></code></p></li>
<li><p>less than -2 ppm:     <code class="docutils literal notranslate"><span class="pre">f1_bounds=&quot;..-2&quot;</span></code>  OR <code class="docutils literal notranslate"><span class="pre">f1_bounds=(None,</span> <span class="pre">-2)</span></code></p></li>
</ul>
</div></blockquote>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl>
<dt><strong>f1_bounds</strong><span class="classifier">str or tuple, optional</span></dt><dd><p>String or tuple describing the indirect-dimension region of interest.
See above for examples. If no bounds are provided, uses the <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">F1P</span></code>
and <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">F2P</span></code> processing parameters, which can be specified via
<code class="docutils literal notranslate"><span class="pre">dpl</span></code>. If these are not specified, defaults to the whole spectrum.</p>
</dd>
<dt><strong>f2_bounds</strong><span class="classifier">str or tuple, optional</span></dt><dd><p>String or tuple describing the direct-dimension region of interest. See
above for examples. If no bounds are provided, uses the <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">F1P</span></code> and
<code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">F2P</span></code> processing parameters, which can be specified via <code class="docutils literal notranslate"><span class="pre">dpl</span></code>. If
these are not specified, defaults to the whole spectrum.</p>
</dd>
<dt><strong>p_spec</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a>, optional</span></dt><dd><p>Path to the procno folder of interest. Defaults to the currently active
spectrum (i.e. <code class="docutils literal notranslate"><span class="pre">_g.p_spectrum</span></code>).</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt><a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.21)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ndarray</span></code></a></dt><dd><p>2D array containing the spectrum or the desired section of it (if
<em>f1_bounds</em> or <em>f2_bounds</em> were specified).</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.get2d_ri">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">get2d_ri</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">f1_bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f2_bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.get2d_ri" title="Permalink to this definition">¶</a></dt>
<dd><p>Same as <a class="reference internal" href="#nmrpoise.poise_backend.cfhelpers.get2d_rr" title="nmrpoise.poise_backend.cfhelpers.get2d_rr"><code class="xref any py py-func docutils literal notranslate"><span class="pre">get2d_rr</span></code></a>, except that it reads the ‘2ri’ file.</p>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.get2d_ir">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">get2d_ir</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">f1_bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f2_bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.get2d_ir" title="Permalink to this definition">¶</a></dt>
<dd><p>Same as <a class="reference internal" href="#nmrpoise.poise_backend.cfhelpers.get2d_rr" title="nmrpoise.poise_backend.cfhelpers.get2d_rr"><code class="xref any py py-func docutils literal notranslate"><span class="pre">get2d_rr</span></code></a>, except that it reads the ‘2ir’ file.</p>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.get2d_ii">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">get2d_ii</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">f1_bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">f2_bounds</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">''</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.get2d_ii" title="Permalink to this definition">¶</a></dt>
<dd><p>Same as <a class="reference internal" href="#nmrpoise.poise_backend.cfhelpers.get2d_rr" title="nmrpoise.poise_backend.cfhelpers.get2d_rr"><code class="xref any py py-func docutils literal notranslate"><span class="pre">get2d_rr</span></code></a>, except that it reads the ‘2ii’ file.</p>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.getpar">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">getpar</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">par</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">p_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.getpar" title="Permalink to this definition">¶</a></dt>
<dd><p>Obtains the value of a numeric (acquisition or processing) parameter.
Non-numeric parameters (i.e. strings) are not currently accessible! Works
for both 1D and 2D spectra (see return type below), but nothing higher.</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl>
<dt><strong>par</strong><span class="classifier">str</span></dt><dd><p>Name of the parameter.</p>
</dd>
<dt><strong>p_spec</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a>, optional</span></dt><dd><p>Path to the procno folder of interest. Defaults to the currently active
spectrum (i.e. <code class="docutils literal notranslate"><span class="pre">_g.p_spectrum</span></code>).</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl>
<dt>float or <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="(in NumPy v1.21)"><code class="xref py py-class docutils literal notranslate"><span class="pre">ndarray</span></code></a></dt><dd><p>Value(s) of the requested parameter. None if the given parameter was
not found.</p>
<p>For parameters that exist for both dimensions of 2D spectra, getpar()
returns an ndarray consisting of (f1_value, f2_value).  Otherwise (for
1D spectra, or for 2D parameters which only apply to the direct
dimension), getpar() returns a float.</p>
<p>Note that a float is returned even for parameters which can logically
only be integers (e.g. TD). If you want an integer you have to manually
convert it using <code class="xref any docutils literal notranslate"><span class="pre">int()</span></code>.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.getndim">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">getndim</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">p_spec</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.getndim" title="Permalink to this definition">¶</a></dt>
<dd><p>Obtains the dimensionality of the spectrum, i.e. the status value of
PARMODE, plus one (becaus PARMODE is 0 for 1D spectra, etc.)</p>
<dl class="field-list">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl>
<dt><strong>p_spec</strong><span class="classifier"><a class="reference external" href="https://docs.python.org/3/library/pathlib.html#pathlib.Path" title="(in Python v3.10)"><code class="xref py py-class docutils literal notranslate"><span class="pre">Path</span></code></a>, optional</span></dt><dd><p>Path to the procno folder of interest. Defaults to the currently active
spectrum (i.e. <code class="docutils literal notranslate"><span class="pre">_g.p_spectrum</span></code>).</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>int</dt><dd><p>Dimensionality of the spectrum.</p>
</dd>
</dl>
</dd>
</dl>
</dd></dl>

<p><br /> </p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.getnfev">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">getnfev</span></span><span class="sig-paren">(</span><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.getnfev" title="Permalink to this definition">¶</a></dt>
<dd><p>Returns the number of NMR spectra evaluated so far. This will be equal to 1
(not 0) the first time the cost function is called, since the cost function
is only called after the NMR spectrum has been acquired.</p>
</dd></dl>

</section>
<section id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>As noted above, printing anything to <code class="docutils literal notranslate"><span class="pre">stdout</span></code> will cause the optimisation to crash.
The reason for this is because <code class="docutils literal notranslate"><span class="pre">stdout</span></code> is reserved for communication between the POISE backend (the Python 3 component) and frontend (which runs in TopSpin).
Please use <a class="reference internal" href="#nmrpoise.poise_backend.cfhelpers.log" title="nmrpoise.poise_backend.cfhelpers.log"><code class="xref any py py-func docutils literal notranslate"><span class="pre">log()</span></code></a> instead, which will print to the <code class="docutils literal notranslate"><span class="pre">poise.log</span></code> file in the expno folder.
It works in exactly the same way as the familiar <code class="docutils literal notranslate"><span class="pre">print()</span></code>, and accepts the same kind of arguments.</p>
<dl class="py function">
<dt class="sig sig-object py" id="nmrpoise.poise_backend.cfhelpers.log">
<span class="sig-prename descclassname"><span class="pre">nmrpoise.poise_backend.cfhelpers.</span></span><span class="sig-name descname"><span class="pre">log</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="o"><span class="pre">*</span></span><span class="n"><span class="pre">args</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#nmrpoise.poise_backend.cfhelpers.log" title="Permalink to this definition">¶</a></dt>
<dd><p>Prints something to the poise.log file.</p>
<p>If this is called from inside a cost function, the text is printed <em>before</em>
the cost function is evaluated, so will appear above the corresponding
function evaluation.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><dl class="simple">
<dt><strong>args</strong></dt><dd><p>The arguments that <code class="docutils literal notranslate"><span class="pre">log()</span></code> takes are exactly the same as those of
<code class="docutils literal notranslate"><span class="pre">print()</span></code>.</p>
</dd>
</dl>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><dl class="simple">
<dt>None</dt><dd></dd>
</dl>
</dd>
</dl>
</dd></dl>

</section>
<section id="premature-termination">
<h2>Premature termination<a class="headerlink" href="#premature-termination" title="Permalink to this headline">¶</a></h2>
<p>In order to terminate an optimisation prematurely, you can raise any exception you like, for example with <code class="docutils literal notranslate"><span class="pre">raise</span> <span class="pre">ValueError</span></code>.
POISE will stop the optimisation, and the error will be displayed in TopSpin.
The drawback of this naive approach is that <em>no information from the incomplete optimisation will be retained</em>.
That means that even if you have found a point that is substantially better than the initial point, it will not be saved.</p>
<p>If you want to terminate <em>and</em> return the best point found so far, please raise a <code class="docutils literal notranslate"><span class="pre">CostFunctionError</span></code> instead of any other exception (such as <code class="docutils literal notranslate"><span class="pre">ValueError</span></code>).
<code class="docutils literal notranslate"><span class="pre">CostFunctionError</span></code> takes up to 2 arguments: the number of arguments to supply depends on whether you want to include the final point which caused the error to be raised.</p>
<p>If you want to discard the last point, i.e. just stop the optimisation right away, then raise a <code class="docutils literal notranslate"><span class="pre">CostFunctionError</span></code> with just 1 argument. The argument should be the message that you want to display to the user:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cost_function</span><span class="p">():</span>
    <span class="n">cost_fn_value</span> <span class="o">=</span> <span class="n">foo</span><span class="p">()</span>   <span class="c1"># whatever calculation you want here</span>
    <span class="k">if</span> <span class="n">some_bad_condition</span><span class="p">:</span>
       <span class="k">raise</span> <span class="n">CostFunctionError</span><span class="p">(</span><span class="s2">&quot;Some bad condition occurred!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cost_fn_value</span>
</pre></div>
</div>
<p>It is possible, and probably advisable, to use this string to show the user helpful information (further steps to take, or the value of the cost function, for example).</p>
<p>Alternatively, you may want the current point (and the corresponding cost function value) to be saved as part of the optimisation.
For example, it may be the case that a certain threshold is “good enough” for the cost function and any value below that is acceptable.
In that situation, you would want to raise CostFunctionError once the cost function goes below that threshold, but <em>also</em> save that point as the best value.
To do so, pass the value of the cost function as the <em>second</em> parameter when raising CostFunctionError:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">cost_function</span><span class="p">():</span>
    <span class="n">cost_fn_value</span> <span class="o">=</span> <span class="n">foo</span><span class="p">()</span>   <span class="c1"># whatever calculation you want here</span>
    <span class="k">if</span> <span class="n">cost_fn_value</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
       <span class="k">raise</span> <span class="n">CostFunctionError</span><span class="p">(</span><span class="s2">&quot;The cost function is below the threshold.&quot;</span><span class="p">,</span>
                               <span class="n">cost_fn_value</span><span class="p">)</span>
    <span class="c1"># Note that we still need the return statement, because it will be used</span>
    <span class="c1"># if cost_fn_value is greater than the threshold.</span>
    <span class="k">return</span> <span class="n">cost_fn_value</span>
</pre></div>
</div>
<p>The value passed as the second argument can in general be any number.
If you want to make sure that the final point (which raised the CostFunctionError) is <em>always</em> chosen to be the optimal point, then you can do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">raise</span> <span class="n">CostFunctionError</span><span class="p">(</span><span class="s2">&quot;A message here&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
</pre></div>
</div>
<p>Because <code class="docutils literal notranslate"><span class="pre">-np.inf</span></code> is smaller than any other possible number, it will always be picked as the “best” point.</p>
</section>
<section id="examples">
<h2>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>There are a number of cost functions which ship with POISE.
These can all be found inside the <code class="docutils literal notranslate"><span class="pre">costfunctions.py</span></code> file referred to above.
This file also contains a number of more specialised cost functions, which were used for the examples in the POISE paper.
(Instead of opening the file, you can also find the <a class="reference external" href="https://github.com/foroozandehgroup/nmrpoise/blob/master/nmrpoise/poise_backend/costfunctions.py">source code on GitHub</a>.)</p>
<p>A number of these are thoroughly commented with detailed explanations; do consider checking these out if you want more guidance on how to write your own cost function.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../">poise</a></h1>








<p></p>
<h3>Useful links</h3>
<ul>
    <li><a href="https://doi.org/10.1021/acs.analchem.1c01767">Paper (<i>Anal. Chem.</i> 2021)</a></li>
    <li><a href="https://arxiv.org/abs/2108.07121">arXiv preprint</a></li>
    <li><a href="https://github.com/foroozandehgroup/nmrpoise">GitHub repository</a></li>
    <li><a href="https://www.youtube.com/watch?v=QTCeSCRZs4I">YouTube video guide</a></li>
    <li><a href="https://foroozandehgroup.github.io/nmrpoise">HTML documentation</a></li>
    <li><a href="https://foroozandehgroup.github.io/nmrpoise/poise.pdf">PDF documentation</a></li>
</ul><h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../install/">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../routines/">Setting up a Routine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../running/">Running an optimisation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../frontend/">Frontend options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../automation/">POISE under automation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../costfunctions/">Builtin cost functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../au/">Builtin AU programmes</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Custom cost functions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#the-rules-for-cost-functions">The rules for cost functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#accessing-spectra-and-parameters">Accessing spectra and parameters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#logging">Logging</a></li>
<li class="toctree-l2"><a class="reference internal" href="#premature-termination">Premature termination</a></li>
<li class="toctree-l2"><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../dev/">Developer notes</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../">Documentation overview</a><ul>
      <li>Previous: <a href="../au/" title="previous chapter">Builtin AU programmes</a></li>
      <li>Next: <a href="../dev/" title="next chapter">Developer notes</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search/" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2021, Jonathan Yong & Mohammadali Foroozandeh.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/customcf.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>